---
# Default deny all ingress and egress traffic in the namespace
# This ensures all traffic must be explicitly allowed
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: finpay-prod
  labels:
    app.kubernetes.io/name: finpay
    app.kubernetes.io/instance: finpay-prod
    app.kubernetes.io/component: network-policy
    app.kubernetes.io/managed-by: kubectl
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress

---
# Allow DNS egress for all pods (required for service discovery)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-egress
  namespace: finpay-prod
  labels:
    app.kubernetes.io/name: finpay
    app.kubernetes.io/instance: finpay-prod
    app.kubernetes.io/component: network-policy
    app.kubernetes.io/managed-by: kubectl
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
# Allow ingress to payment-api from ALB (any source for internet-facing)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-payment-api-ingress
  namespace: finpay-prod
  labels:
    app.kubernetes.io/name: payment-api
    app.kubernetes.io/instance: finpay-prod
    app.kubernetes.io/component: network-policy
    app.kubernetes.io/managed-by: kubectl
spec:
  podSelector:
    matchLabels:
      app: payment-api
  policyTypes:
    - Ingress
  ingress:
    # Allow from ALB (all sources since ALB is internet-facing)
    - ports:
        - protocol: TCP
          port: 8080

---
# Allow payment-api to call payment-worker
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-api-to-worker
  namespace: finpay-prod
  labels:
    app.kubernetes.io/name: payment-worker
    app.kubernetes.io/instance: finpay-prod
    app.kubernetes.io/component: network-policy
    app.kubernetes.io/managed-by: kubectl
spec:
  podSelector:
    matchLabels:
      app: payment-worker
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: payment-api
      ports:
        - protocol: TCP
          port: 8090

---
# Allow payment-worker to callback payment-api
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-worker-to-api
  namespace: finpay-prod
  labels:
    app.kubernetes.io/name: payment-api
    app.kubernetes.io/instance: finpay-prod
    app.kubernetes.io/component: network-policy
    app.kubernetes.io/managed-by: kubectl
spec:
  podSelector:
    matchLabels:
      app: payment-api
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: payment-worker
      ports:
        - protocol: TCP
          port: 8080

---
# Allow payment-api egress to payment-worker and RDS
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: payment-api-egress
  namespace: finpay-prod
  labels:
    app.kubernetes.io/name: payment-api
    app.kubernetes.io/instance: finpay-prod
    app.kubernetes.io/component: network-policy
    app.kubernetes.io/managed-by: kubectl
spec:
  podSelector:
    matchLabels:
      app: payment-api
  policyTypes:
    - Egress
  egress:
    # Allow egress to payment-worker
    - to:
        - podSelector:
            matchLabels:
              app: payment-worker
      ports:
        - protocol: TCP
          port: 8090
    # Allow egress to RDS (database subnet CIDR)
    # Adjust CIDR to match your database subnets
    - to:
        - ipBlock:
            cidr: 10.0.20.0/23
      ports:
        - protocol: TCP
          port: 5432

---
# Allow payment-worker egress to payment-api (for callbacks)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: payment-worker-egress
  namespace: finpay-prod
  labels:
    app.kubernetes.io/name: payment-worker
    app.kubernetes.io/instance: finpay-prod
    app.kubernetes.io/component: network-policy
    app.kubernetes.io/managed-by: kubectl
spec:
  podSelector:
    matchLabels:
      app: payment-worker
  policyTypes:
    - Egress
  egress:
    # Allow egress to payment-api for callbacks
    - to:
        - podSelector:
            matchLabels:
              app: payment-api
      ports:
        - protocol: TCP
          port: 8080
