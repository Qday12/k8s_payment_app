apiVersion: apps/v1
kind: Deployment
metadata:
  name: payment-api
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "finpay.labels" . | nindent 4 }}
    app: payment-api
  annotations:
    eks.amazonaws.com/role-arn: {{ .Values.iam.paymentApiRoleArn }}

spec:
  replicas: {{ .Values.paymentApi.replicaCount }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: payment-api
  template:
    metadata:
      labels:
        {{- include "finpay.labels" . | nindent 8 }}
        app: payment-api
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
      nodeSelector:
        node-group: application
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: payment-api
                topologyKey: kubernetes.io/hostname
      containers:
        - name: payment-api
          image: {{ .Values.paymentApi.image.repository }}:{{ .Values.paymentApi.image.tag }}
          imagePullPolicy: {{ .Values.paymentApi.image.pullPolicy }}
          ports:
            - name: http
              containerPort: 8080
          env:
            - name: APP_ENV
              valueFrom:
                configMapKeyRef:
                  name: finpay-config
                  key: APP_ENV
            - name: LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: finpay-config
                  key: LOG_LEVEL
            - name: PAYMENT_DB_URL
              valueFrom:
                configMapKeyRef:
                  name: finpay-config
                  key: DB_URL
            - name: PAYMENT_DB_USER
              valueFrom:
                secretKeyRef:
                  name: finpay-db-secret
                  key: DB_USER
            - name: PAYMENT_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: finpay-db-secret
                  key: DB_PASSWORD
            - name: PAYMENT_WORKER_BASE_URL
              value: http://payment-worker:8090
            # JAVA_OPTS required for readOnlyRootFilesystem: true
            # - java.io.tmpdir=/tmp: Use mounted emptyDir for temp files
            # - --add-opens: Allow Tomcat to access internal Java modules (Java 17+ restriction)
            - name: JAVA_OPTS
              value: "-Djava.io.tmpdir=/tmp --add-opens java.base/java.io=ALL-UNNAMED --add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.rmi/sun.rmi.transport=ALL-UNNAMED"
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /actuator/ready
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          startupProbe:
            httpGet:
              path: /actuator/health
              port: 8080
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 30
          resources:
            requests:
              cpu: {{ .Values.paymentApi.resources.requests.cpu }}
              memory: {{ .Values.paymentApi.resources.requests.memory }}
            limits:
              cpu: {{ .Values.paymentApi.resources.limits.cpu }}
              memory: {{ .Values.paymentApi.resources.limits.memory }}
          securityContext:
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}
